Часто программу можно переписать так, чтобы исключить одновременную модификацию данных несколькими горутинами. В нашем случае, например, так:

-   каждая из горутин `count(`) посчитает слова в отдельной карте;
-   отдельная горутина `merge()` пройдет по получившимся картам и построит итоговую.

```go
func main() {
    rand.Seed(0)

    in := generate(100, 3)
    counters := make([]map[string]int, 2)

    var wg sync.WaitGroup
    wg.Add(2)

    go count(&wg, in, counters, 0)
    go count(&wg, in, counters, 1)

    wg.Wait()

    counter := merge(counters...)
    fmt.Println(counter)
}

// считает частоты слов
func count(wg *sync.WaitGroup, in <-chan string, counters []map[string]int, idx int) {
    defer wg.Done()
    counter := map[string]int{}
    for word := range in {
        counter[word]++
    }
    counters[idx] = counter
}

// объединяет карты частот в итоговую карту
func merge(counters ...map[string]int) map[string]int {
    merged := map[string]int{}
    for _, counter := range counters {
        for word, freq := range counter {
            merged[word] += freq
        }
    }
    return merged
}
```

Формально, мы все еще используем общие данные — срез `counters` в `count()`. Но параметр `idx` гарантирует, что первая `count()` обращается только к первому элементу среза, а вторая — только ко второму. Такое одновременное использование среза Go допускает. Главное, чтобы несколько горутин не пытались изменить один и тот же элемент среза или выполнить `append()`.

Даже если бы Go в принципе не разрешал одновременное обращение к срезу — мы все равно решили бы задачу. Просто использовали бы канал карт вместо среза:

-   каждая из горутин `count(`) считает слова в отдельной карте и отправляет в общий канал;
-   отдельная горутина `merge()` читает из общего канала и строит итоговую карту.

Приводить этот вариант не буду. Думаю, вы и так отлично представляете, как его реализовать.

В любом случае, решение с отдельным этапом `merge()` рабочее. Но не всегда удобное. Бывает, мы хотим модифицировать одни и те же данные из нескольких горутин. Вот хотим, и все тут. Имеем право ツ Давайте посмотрим, как это сделать.