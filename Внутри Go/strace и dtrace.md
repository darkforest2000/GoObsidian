# strace

Утилита командной строки strace(1) позволяет отслеживать системные вызовы и сигналы. Поскольку strace(1) работает только на компьютерах с Linux, в этом разделе для демонстрации strace(1) будет использоваться компьютер с Debian Linux.  
Утилита strace(1) выводит на экран следующую информацию:  
```bash
$ strace ls  
execve("/bin/ls", ["ls"], [/* 15 vars */]) = 0  
brk(0) = 0x186c000  
fstat(3, {st_mode=S_IFREG|0644, st_size=35288, ...}) = 0  
```
В выходных данных strace(1) отображаются все системные вызовы вместе с их параметрами, а также возвращаемыми значениями. Обратите внимание: в мире UNIX, если функция возвращает 0 — это хорошо.  

Для того чтобы обработать исполняемый файл, следует поместить команду strace(1) перед файлом, который вы хотите обработать. Однако, чтобы сделать полезные выводы из результатов, вам придется их самостоятельно интерпретировать.  

К счастью, такие утилиты, как grep(1), позволяют получить результат, который нам действительно нужен:  

```bash
$ strace find /usr 2>&1 | grep ioctl  
ioctl(0, SNDCTL_TMR_TIMEBASE or SNDRV_TIMER_IOCTL_NEXT_DEVICE or  
TCGETS, 0x7ffe3bc59c50) = -1 ENOTTY (Inappropriate ioctl for device)  
ioctl(1, SNDCTL_TMR_TIMEBASE or SNDRV_TIMER_IOCTL_NEXT_DEVICE or  
TCGETS, 0x7ffe3bc59be0) = -1 ENOTTY (Inappropriate ioctl for device)  
```

При использовании параметра командной строки -c утилита strace(1) позволяет выводить счетчик времени, вызовы и ошибки для каждого системного вызова:  

```bash
$ strace -c find /usr 1>/dev/null  
% time seconds    usecs/call   calls   errors      syscall  
------ --------- ----------- --------- --------- -------------  
82.88  0.063223        2       39228               getdents  
16.60  0.012664        1       19587               newfstatat  
0.16   0.000119        0       19618       13      open  
```

Поскольку обычно результаты программы попадают в стандартный поток вывода, а результаты strace(1) — в стандартный поток ошибок, выполненная выше команда отменяет вывод результатов проверяемой команды find и показывает результаты команды strace(1). Как видно из последней строки выходных данных, системный вызов open(2) сделан 19 618 раз, при этом возникло 13 ошибок и все это заняло примерно 0,16 % времени выполнения всей команды, или  0,000119 секунды.

# dtrace

Утилиты отладки, такие как strace(1) и truss(1), позволяют отслеживать системные вызовы, производимые процессом, однако иногда они бывают медленными и поэтому не подходят для решения проблем производительности в высоконагруженных UNIX-системах. Еще одна утилита, называемая DTrace, позволяет увидеть, что происходит внутри всей системы, без необходимости что-либо изменять или  
перекомпилировать. DTrace также позволяет работать в системах, находящихся в процессе эксплуатации, и динамически наблюдать за работающими программами и серверными процессами, не создавая больших дополнительных нагрузок.

В этом подразделе используется утилита командной строки dtruss(1), поставляемая с macOS. Это просто сценарий для dtrace(1), который показывает системные  
вызовы процесса и избавляет нас от необходимости самостоятельно писать скрипт для dtrace(1). Обратите внимание, что для выполнения dtrace(1) и dtruss(1) не-  
обходимы права пользователя root.  Утилита dtruss(1) выводит на экран следующие данные:  

```bash
$ sudo dtruss godoc  
ioctl(0x3, 0x80086804, 0x7FFEEFBFEC20) = 0 0  
close(0x3) = 0 0  
access("/AppleInternal/XBS/.isChrooted\0", 0x0, 0x0) = -1 Err#2  
thread_selfid(0x0, 0x0, 0x0) = 1895378 0  
geteuid(0x0, 0x0, 0x0) = 0 0  
getegid(0x0, 0x0, 0x0) = 0 0  
```

Как видим, dtruss(1) работает так же, как утилита strace(1). Подобно  strace(1), dtruss(1) при использовании с параметром -c выводит счетчик системных вызовов:

```bash
$ sudo dtruss -c go run unsafe.go 2>&1  
CALL COUNT  
access 1  
bsdthread_register 1  
getuid 1  
ioctl 1  
issetugid 1  
kqueue 1  
write 1  
mkdir 2  
read 244  
kevent 474
fcntl 479  
lstat64 553  
psynch_cvsignal 649  
psynch_cvwait 654
```

Эти данные сразу сообщат вам о возможных узких местах вашего Go-кода или позволят сравнить производительность двух утилит командной строки.

	К утилитам, подобным strace(1), dtrace(1) и dtruss(1), нужно привыкнуть. Однако такие инструменты способны сделать нашу жизнь намного проще  
	и комфортнее, поэтому я настоятельно рекомендую вам прямо сейчас начать изучение хотя бы одного такого инструмента.


[[Внутри Go]]